{% extends "base.html" %}

{% block content %}
<!-- Dashboard container with data attributes -->
<div id="dashboard-container" 
    data-currency="{{ base_currency.symbol }}"
    data-savings-rate="{{ savings_rate }}"
    data-expense-income-ratio="{{ expense_income_ratio }}"
    data-liquidity-ratio="{{ liquidity_ratio }}"
    data-account-growth="{{ account_growth }}"
    data-months="{{ monthly_labels|tojson }}"
    data-income-data="{{ monthly_income|tojson }}"
    data-expense-data="{{ monthly_amounts|tojson }}"
    data-category-names="{{ category_names|tojson }}"
    data-category-totals="{{ category_totals|tojson }}"
    data-tag-names="{{ tag_names|tojson }}"
    data-tag-totals="{{ tag_totals|tojson }}"
    data-tag-colors="{{ tag_colors|tojson }}"
    data-total-income="{{ total_income|default(0) }}"
    data-total-expenses="{{ total_expenses_only|default(0) }}"
    data-total-transfers="{{ total_transfers|default(0) }}">

<div class="container">
    <div class="row mb-4">
        <div class="col-md-12">
            <h2 style="background: linear-gradient(90deg, #0ea5e9, #8b5cf6); -webkit-background-clip: text; background-clip: text; color: transparent; font-weight: bold;">
                <i class="fas fa-chart-bar me-3" style="color: #a855f7;"></i>Financial Analytics Dashboard
            </h2>
            <p class="text-muted">Comprehensive insights into your income, expenses, transfers and financial health</p>
        </div>
    </div>
    
    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs mb-4" id="analyticsTab" role="tablist" style="border-color: rgba(148, 163, 184, 0.2);">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true" style="color: #38bdf8; border-color: rgba(148, 163, 184, 0.2);">
                <i class="fas fa-home me-2"></i>Overview
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="comparison-tab" data-bs-toggle="tab" data-bs-target="#comparison" type="button" role="tab" aria-controls="comparison" aria-selected="false" style="color: #8b5cf6; border-color: rgba(148, 163, 184, 0.2);">
                <i class="fas fa-chart-line me-2"></i>Comparison
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="investment-tab" data-bs-toggle="tab" data-bs-target="#investment" type="button" role="tab" aria-controls="investment" aria-selected="false" style="color: #10b981; border-color: rgba(148, 163, 184, 0.2);">
                <i class="fas fa-chart-pie me-2"></i>Investments
            </button>
        </li>
    </ul>


<!-- Tab Content -->
<div class="tab-content" id="analyticsTabContent">
    <!-- OVERVIEW TAB -->
    <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">

<!-- Filter Controls - Only visible on Overview tab -->
<div class="card mb-4" id="customizeViewPanel" style="background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(30, 41, 59, 0.95));">
    <div class="card-header" style="background: rgba(15, 23, 42, 0.7); border-bottom: 1px solid rgba(148, 163, 184, 0.2);">
        <h5 class="mb-0"><i class="fas fa-sliders-h me-2" style="color: #a855f7;"></i>Customize View</h5>
    </div>
    <div class="card-body">
        <form id="statsFilterForm">
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label" style="color: #94a3b8;"><i class="far fa-calendar-alt me-2" style="color: #38bdf8;"></i>Date Range</label>
                    <div class="input-group">
                        <input type="date" class="form-control bg-dark text-light" id="startDate" name="startDate" style="border-color: #475569;">
                        <span class="input-group-text bg-dark text-light" style="border-color: #475569; color: #94a3b8;">to</span>
                        <input type="date" class="form-control bg-dark text-light" id="endDate" name="endDate" style="border-color: #475569;">
                    </div>
                </div>
                <div class="col-md-2 mb-3">
                    <label class="form-label" style="color: #94a3b8;"><i class="fas fa-users me-2" style="color: #818cf8;"></i>Group</label>
                    <select class="form-select bg-dark text-light" id="groupFilter" name="groupId" style="border-color: #475569;">
                        <option value="all">All Groups</option>
                        <option value="none">Personal Only</option>
                        {% for group in current_user.groups %}
                            <option value="{{ group.id }}">{{ group.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2 mb-3">
                    <label class="form-label" style="color: #94a3b8;"><i class="fas fa-exchange-alt me-2" style="color: #f59e0b;"></i>Transaction Type</label>
                    <select class="form-select bg-dark text-light" id="transactionTypeFilter" name="transactionType" style="border-color: #475569;">
                        <option value="all">All Transactions</option>
                        <option value="expense">Expenses Only</option>
                        <option value="income">Income Only</option>
                        <option value="transfer">Transfers Only</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label" style="color: #94a3b8;"><i class="fas fa-university me-2" style="color: #f97316;"></i>Account</label>
                    <select class="form-select bg-dark text-light" id="accountFilter" name="accountId" style="border-color: #475569;">
                        <option value="all">All Accounts</option>
                        <!-- Will be populated with user accounts via JavaScript -->
                    </select>
                </div>
                <div class="col-md-2 mb-3 d-flex align-items-end">
                    <button type="button" class="btn w-100" id="applyFilters" style="background: linear-gradient(135deg, #6366f1, #8b5cf6); border: none; box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.2);">
                        <i class="fas fa-filter me-2"></i>Apply
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card h-100" style="border-top: 4px solid #10b981;">
                    <div class="card-body">
                        <h5 class="card-title text-muted mb-2">
                            <i class="fas fa-arrow-down me-2" style="color: #10b981;"></i>Total Income
                        </h5>
                        <h3 class="mb-0" id="totalIncome" style="color: #10b981;">{{ base_currency.symbol }}{{ "%.2f"|format(total_income|default(0)) }}</h3>
                        <p class="text-muted mt-2" id="incomeTrend">
                            <i class="fas fa-arrow-up text-success"></i> <span id="incomeTrendValue">{{ "%.1f"|format(income_trend|default(0)) }}</span>% from last period
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card h-100" style="border-top: 4px solid #ef4444;">
                    <div class="card-body">
                        <h5 class="card-title text-muted mb-2">
                            <i class="fas fa-arrow-up me-2" style="color: #ef4444;"></i>Total Expenses
                        </h5>
                        <h3 class="mb-0" id="totalExpenses" style="color: #ef4444;">{{ base_currency.symbol }}{{ "%.2f"|format(total_expenses_only) }}</h3>
                        <p class="text-muted mt-2" id="expenseTrend">
                            {% if spending_trend > 0 %}
                            <i class="fas fa-arrow-up text-danger"></i> {{ "%.1f"|format(spending_trend) }}% from last period
                            {% elif spending_trend < 0 %}
                            <i class="fas fa-arrow-down text-success"></i> {{ "%.1f"|format(spending_trend|abs) }}% from last period
                            {% else %}
                            <i class="fas fa-equals text-warning"></i> No change from last period
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card h-100" style="border-top: 4px solid #3b82f6;">
                    <div class="card-body">
                        <h5 class="card-title text-muted mb-2">
                            <i class="fas fa-money-bill-wave me-2" style="color: #3b82f6;"></i>Net Cash Flow
                        </h5>
                        <h3 class="mb-0" id="netCashFlow" style="color: #3b82f6;">{{ base_currency.symbol }}{{ "%.2f"|format(net_cash_flow|default(0)) }}</h3>
                        <p class="text-muted mt-2" id="savingsRate">
                            Savings Rate: <span id="savingsRateValue">{{ "%.1f"|format(savings_rate) if savings_rate is defined else "N/A" }}</span>{{ "%" if savings_rate is defined }}
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card h-100" style="border-top: 4px solid {{ '#10b981' if net_balance >= 0 else '#ef4444' }};">
                    <div class="card-body">
                        <h5 class="card-title text-muted mb-2">
                            <i class="fas fa-balance-scale me-2" style="color: {{ '#10b981' if net_balance >= 0 else '#ef4444' }};"></i>Net Balance
                        </h5>
                        <h3 class="mb-0 {{ 'text-success' if net_balance >= 0 else 'text-danger' }}" id="netBalance">
                            {{ base_currency.symbol }}{{ "%.2f"|format(net_balance|abs) }} {{ 'Owed' if net_balance >= 0 else 'Owing' }}
                        </h3>
                        <p class="text-muted mt-2">From {{ balance_count }} active IOUs</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Income vs Expense Analysis -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header" style="background: rgba(15, 23, 42, 0.7);">
                        <h5 class="mb-0"><i class="fas fa-chart-line me-2" style="color: #3b82f6;"></i>Income vs Expenses</h5>
                    </div>
                    <div class="card-body" style="background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.8));">
                        <div class="chart-container" style="position: relative; height:300px;">
                            <canvas id="incomeExpenseChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Transaction Type Distribution and Financial Health -->
        <div class="row mb-4">
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-header" style="background: rgba(15, 23, 42, 0.7);">
                        <h5 class="mb-0"><i class="fas fa-chart-pie me-2" style="color: #a855f7;"></i>Transaction Type Distribution</h5>
                    </div>
                    <div class="card-body" style="background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.8));">
                        <div class="row">
                            <div class="col-md-7">
                                <div class="chart-container" style="position: relative; height:250px;">
                                    <canvas id="transactionTypeChart"></canvas>
                                </div>
                            </div>
                            <div class="col-md-5">
                                <div class="transaction-stats">
                                    <h6 class="text-muted mb-3">Transaction Summary</h6>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span><i class="fas fa-arrow-down me-2" style="color: #10b981;"></i>Income:</span>
                                        <span id="incomeStat" style="color: #10b981;">{{ base_currency.symbol }}{{ "%.2f"|format(total_income|default(0)) }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span><i class="fas fa-arrow-up me-2" style="color: #ef4444;"></i>Expenses:</span>
                                        <span id="expenseStat" style="color: #ef4444;">{{ base_currency.symbol }}{{ "%.2f"|format(total_expenses_only) }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span><i class="fas fa-exchange-alt me-2" style="color: #a855f7;"></i>Transfers:</span>
                                        <span id="transferStat" style="color: #a855f7;">{{ base_currency.symbol }}{{ "%.2f"|format(total_transfers|default(0)) }}</span>
                                    </div>
                                    <hr style="border-color: rgba(148, 163, 184, 0.2);">
                                    <div class="d-flex justify-content-between">
                                        <span><i class="fas fa-money-bill-wave me-2" style="color: #3b82f6;"></i>Net:</span>
                                        <span id="netStat" style="color: #3b82f6;">{{ base_currency.symbol }}{{ "%.2f"|format(net_cash_flow|default(0)) }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-header" style="background: rgba(15, 23, 42, 0.7);">
                        <h5 class="mb-0"><i class="fas fa-heartbeat me-2" style="color: #f97316;"></i>Financial Health Indicators</h5>
                    </div>
                    <div class="card-body" style="background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.8));">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <!-- Savings Rate Gauge -->
                                <div class="metric-card mb-3">
                                    <h6 class="text-muted mb-1">Savings Rate</h6>
                                    <div class="gauge-container">
                                        <div class="gauge-value" id="savingsRateGauge">
                                            <span id="savingsRateDisplay">{{ "%.1f"|format(savings_rate) if savings_rate is defined else "N/A" }}{{ "%" if savings_rate is defined }}</span>
                                        </div>
                                        <div class="gauge-info text-muted mt-1">
                                            <small>Income saved after expenses</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Expense to Income Ratio -->
                                <div class="metric-card">
                                    <h6 class="text-muted mb-1">Expense-to-Income Ratio</h6>
                                    <div class="gauge-container">
                                        <div class="gauge-value" id="expenseIncomeRatioGauge">
                                            <span id="expenseIncomeRatioDisplay">{{ "%.1f"|format(expense_income_ratio) if expense_income_ratio is defined else "N/A" }}{{ "%" if expense_income_ratio is defined }}</span>
                                        </div>
                                        <div class="gauge-info text-muted mt-1">
                                            <small>Target: Below 80%</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <!-- Liquidity Metric -->
                                <div class="metric-card mb-3">
                                    <h6 class="text-muted mb-1">Liquidity</h6>
                                    <div class="gauge-container">
                                        <div class="gauge-value" id="liquidityGauge">
                                            <span id="liquidityDisplay">{{ "%.1f"|format(liquidity_ratio) if liquidity_ratio is defined else "N/A" }}</span>
                                        </div>
                                        <div class="gauge-info text-muted mt-1">
                                            <small>Months of expenses covered</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Account Growth Rate -->
                                <div class="metric-card">
                                    <h6 class="text-muted mb-1">Account Growth Rate</h6>
                                    <div class="gauge-container">
                                        <div class="gauge-value" id="accountGrowthGauge">
                                            <span id="accountGrowthDisplay">{{ "%.1f"|format(account_growth) if account_growth is defined else "N/A" }}{{ "%" if account_growth is defined }}</span>
                                        </div>
                                        <div class="gauge-info text-muted mt-1">
                                            <small>Year-over-year change</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Category Visualization -->
        <div class="row mb-4">
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-header" style="background: rgba(15, 23, 42, 0.7);">
                        <h5 class="mb-0"><i class="fas fa-layer-group me-2" style="color: #ec4899;"></i>Spending by Category</h5>
                    </div>
                    <div class="card-body" style="background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.8));">
                        <div class="chart-container" style="position: relative; height:300px;">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-header" style="background: rgba(15, 23, 42, 0.7);">
                        <h5 class="mb-0"><i class="fas fa-tags me-2" style="color: #f43f5e;"></i>Top Tags Analysis</h5>
                    </div>
                    <div class="card-body" style="background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.8));">
                        <div class="chart-container" style="position: relative; height:300px;">
                            <canvas id="tagChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Transactions Table -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center" style="background: rgba(15, 23, 42, 0.7);">
                        <h5 class="mb-0"><i class="fas fa-star me-2" style="color: #facc15;"></i>Recent Transactions</h5>
                        <div>
                            <span class="badge" style="background: linear-gradient(135deg, #f97316, #facc15);">Latest {{ top_expenses|length }} transactions</span>
                        </div>
                    </div>
                    <div class="card-body" style="background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.8));">
                        <div class="table-responsive">
                            <table class="table table-borderless">
                                <thead>
                                    <tr style="border-bottom: 1px solid rgba(148, 163, 184, 0.2);">
                                        <th style="color: #94a3b8;"><i class="far fa-calendar-alt me-2"></i>Date</th>
                                        <th style="color: #94a3b8;"><i class="fas fa-tag me-2"></i>Description</th>
                                        <th style="color: #94a3b8;"><i class="fas fa-exchange-alt me-2"></i>Type</th>
                                        <th style="color: #94a3b8;"><i class="fas fa-dollar-sign me-2"></i>Amount</th>
                                        <th style="color: #94a3b8;"><i class="fas fa-university me-2"></i>Account</th>
                                        <th style="color: #94a3b8;"><i class="fas fa-layer-group me-2"></i>Category</th>
                                        <th style="color: #94a3b8;"><i class="fas fa-users me-2"></i>Group</th>
                                    </tr>
                                </thead>
                                <tbody id="recentTransactionsBody">
                                    {% for expense in top_expenses %}
                                    <tr style="border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                                        <td>{{ expense.date.strftime('%Y-%m-%d') }}</td>
                                        <td>{{ expense.description }}</td>
                                        <td>
                                            {% if expense.transaction_type == 'income' %}
                                            <span class="badge" style="background: linear-gradient(135deg, #047857, #10b981);">Income</span>
                                            {% elif expense.transaction_type == 'transfer' %}
                                            <span class="badge" style="background: linear-gradient(135deg, #7c3aed, #a855f7);">Transfer</span>
                                            {% else %}
                                            <span class="badge" style="background: linear-gradient(135deg, #b91c1c, #ef4444);">Expense</span>
                                            {% endif %}
                                        </td>
                                        <td style="{% if expense.transaction_type == 'income' %}color: #10b981; font-weight: bold;{% elif expense.transaction_type == 'expense' %}color: #ef4444; font-weight: bold;{% else %}color: #a855f7; font-weight: bold;{% endif %}">
                                            {% if expense.transaction_type == 'income' %}+{% elif expense.transaction_type == 'expense' %}-{% endif %}{{ base_currency.symbol }}{{ "%.2f"|format(expense.user_portion) }}
                                        </td>
                                        <td>
                                            {% if expense.account %}
                                            <span class="badge bg-dark text-light">{{ expense.account.name }}</span>
                                            {% else %}
                                            <span class="badge bg-secondary">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if expense.category_name %}
                                            <span class="badge" style="background-color: {{ expense.category_color|default('#6c757d') }};">
                                                <i class="fas {{ expense.category_icon|default('fa-tag') }} me-1"></i> {{ expense.category_name }}
                                            </span>
                                            {% else %}
                                            <span class="badge bg-secondary">Uncategorized</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if expense.group_name %}
                                            <span class="badge" style="background: linear-gradient(135deg, #10b981, #34d399);">{{ expense.group_name }}</span>
                                            {% else %}
                                            <span class="badge bg-secondary">-</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- End of Overview Tab -->
    
    <!-- INCOME TAB -->
    <div class="tab-pane fade" id="income" role="tabpanel" aria-labelledby="income-tab">
        <div class="row mb-3">
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i> The Income analytics tab will be available in the next update.
                </div>
            </div>
        </div>
    </div> <!-- End of Income Tab -->
    
    <!-- EXPENSES TAB -->
    <div class="tab-pane fade" id="expenses" role="tabpanel" aria-labelledby="expenses-tab">
        <div class="row mb-3">
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i> The Expenses analytics tab will be available in the next update.
                </div>
            </div>
        </div>
    </div> <!-- End of Expenses Tab -->
    
    <!-- TRANSFERS TAB -->
    <div class="tab-pane fade" id="transfers" role="tabpanel" aria-labelledby="transfers-tab">
        <div class="row mb-3">
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i> The Transfers analytics tab will be available in the next update.
                </div>
            </div>
        </div>
    </div> <!-- End of Transfers Tab -->
    <!-- COMPARISON TAB -->
<div class="tab-pane fade" id="comparison" role="tabpanel" aria-labelledby="comparison-tab">
    <!-- Comparison Controls -->
    <div class="card mb-4" style="background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(30, 41, 59, 0.95));">
        <div class="card-header" style="background: rgba(15, 23, 42, 0.7); border-bottom: 1px solid rgba(148, 163, 184, 0.2);">
            <h5 class="mb-0"><i class="fas fa-exchange-alt me-2" style="color: #8b5cf6;"></i>Compare Time Periods</h5>
        </div>
        <div class="card-body">
            <form id="comparisonForm">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label" style="color: #94a3b8;"><i class="far fa-calendar-alt me-2" style="color: #38bdf8;"></i>Primary Period</label>
                        <div class="input-group">
                            <input type="date" class="form-control bg-dark text-light" id="primaryStartDate" name="primaryStart" style="border-color: #475569;">
                            <span class="input-group-text bg-dark text-light" style="border-color: #475569; color: #94a3b8;">to</span>
                            <input type="date" class="form-control bg-dark text-light" id="primaryEndDate" name="primaryEnd" style="border-color: #475569;">
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label" style="color: #94a3b8;"><i class="far fa-calendar-alt me-2" style="color: #a855f7;"></i>Comparison Period</label>
                        <div class="input-group">
                            <input type="date" class="form-control bg-dark text-light" id="comparisonStartDate" name="comparisonStart" style="border-color: #475569;">
                            <span class="input-group-text bg-dark text-light" style="border-color: #475569; color: #94a3b8;">to</span>
                            <input type="date" class="form-control bg-dark text-light" id="comparisonEndDate" name="comparisonEnd" style="border-color: #475569;">
                        </div>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label class="form-label" style="color: #94a3b8;"><i class="fas fa-chart-line me-2" style="color: #f59e0b;"></i>Metric</label>
                        <select class="form-select bg-dark text-light" id="comparisonMetric" name="metric" style="border-color: #475569;">
                            <option value="spending">Spending</option>
                            <option value="categories">Categories</option>
                            <option value="tags">Tags</option>
                            <option value="payment">Payment Methods</option>
                        </select>
                    </div>
                    <div class="col-md-2 mb-3 d-flex align-items-end">
                        <button type="button" class="btn w-100" id="runComparisonBtn" style="background: linear-gradient(135deg, #8b5cf6, #d946ef); border: none; box-shadow: 0 4px 6px -1px rgba(139, 92, 246, 0.2);">
                            <i class="fas fa-sync-alt me-2"></i>Compare
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Comparison Results -->
    <div id="comparisonResults" style="display: none;">
        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card" style="border-left: 4px solid #38bdf8;">
                    <div class="card-body">
                        <h5 class="card-title mb-3"><i class="fas fa-calendar-day me-2" style="color: #38bdf8;"></i>Primary Period</h5>
                        <div class="row">
                            <div class="col-md-4 mb-2">
                                <span class="text-muted d-block">Total Spending:</span>
                                <span id="primaryTotalSpending" class="fs-5 fw-bold" style="color: #38bdf8;"></span>
                            </div>
                            <div class="col-md-4 mb-2">
                                <span class="text-muted d-block">Transactions:</span>
                                <span id="primaryTransactionCount" class="fs-5 fw-bold" style="color: #38bdf8;"></span>
                            </div>
                            <div class="col-md-4 mb-2">
                                <span class="text-muted d-block">Top Category:</span>
                                <span id="primaryTopCategory" class="fs-5 fw-bold" style="color: #38bdf8;"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card" style="border-left: 4px solid #a855f7;">
                    <div class="card-body">
                        <h5 class="card-title mb-3"><i class="fas fa-calendar-week me-2" style="color: #a855f7;"></i>Comparison Period</h5>
                        <div class="row">
                            <div class="col-md-4 mb-2">
                                <span class="text-muted d-block">Total Spending:</span>
                                <span id="comparisonTotalSpending" class="fs-5 fw-bold" style="color: #a855f7;"></span>
                            </div>
                            <div class="col-md-4 mb-2">
                                <span class="text-muted d-block">Transactions:</span>
                                <span id="comparisonTransactionCount" class="fs-5 fw-bold" style="color: #a855f7;"></span>
                            </div>
                            <div class="col-md-4 mb-2">
                                <span class="text-muted d-block">Top Category:</span>
                                <span id="comparisonTopCategory" class="fs-5 fw-bold" style="color: #a855f7;"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Difference Card -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3"><i class="fas fa-percentage me-2" style="color: #f59e0b;"></i>Key Differences</h5>
                        <div class="row text-center">
                            <div class="col-md-4 mb-2">
                                <span class="text-muted d-block">Spending Difference:</span>
                                <span id="spendingDifference" class="fs-4 fw-bold"></span>
                                <span id="spendingChangePercent" class="d-block"></span>
                            </div>
                            <div class="col-md-4 mb-2">
                                <span class="text-muted d-block">Transaction Difference:</span>
                                <span id="transactionDifference" class="fs-4 fw-bold"></span>
                                <span id="transactionChangePercent" class="d-block"></span>
                            </div>
                            <div class="col-md-4 mb-2">
                                <span class="text-muted d-block">Daily Average Difference:</span>
                                <span id="avgDailyDifference" class="fs-4 fw-bold"></span>
                                <span id="avgDailyChangePercent" class="d-block"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Chart Cards -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header" style="background: rgba(15, 23, 42, 0.7);">
                        <h5 class="mb-0"><i class="fas fa-chart-line me-2" style="color: #f59e0b;"></i><span id="comparisonChartTitle">Spending Comparison</span></h5>
                    </div>
                    <div class="card-body" style="background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.8));">
                        <div class="chart-container" style="position: relative; height:400px;">
                            <canvas id="comparisonChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Detailed Comparison Table -->
        <div id="categoryTagComparison" style="display: none;">
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center" style="background: rgba(15, 23, 42, 0.7);">
                            <h5 class="mb-0"><i class="fas fa-table me-2" style="color: #10b981;"></i><span id="comparisonTableTitle">Detailed Comparison</span></h5>
                        </div>
                        <div class="card-body" style="background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.8));">
                            <div class="table-responsive">
                                <table class="table table-borderless" id="detailedComparisonTable">
                                    <thead>
                                        <tr style="border-bottom: 1px solid rgba(148, 163, 184, 0.2);">
                                            <th style="color: #94a3b8;"><span id="itemTypeHeader">Item</span></th>
                                            <th style="color: #94a3b8; text-align: right;">Primary Amount</th>
                                            <th style="color: #94a3b8; text-align: right;">Comparison Amount</th>
                                            <th style="color: #94a3b8; text-align: right;">Difference</th>
                                            <th style="color: #94a3b8; text-align: right;">Change %</th>
                                        </tr>
                                    </thead>
                                    <tbody id="detailedComparisonBody">
                                        <!-- Will be populated dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- No Data Message (initially shown) -->
    <div id="noComparisonData" class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark" style="border: 1px dashed rgba(148, 163, 184, 0.3);">
                <div class="card-body text-center p-5">
                    <i class="fas fa-chart-line mb-3" style="font-size: 3rem; color: rgba(148, 163, 184, 0.3);"></i>
                    <h4 class="text-muted">Select time periods to compare</h4>
                    <p class="text-muted">Choose two time periods and a metric to see a side-by-side comparison of your financial data.</p>
                    <button class="btn mt-3" id="setDefaultPeriodsBtn" style="background: linear-gradient(135deg, #6366f1, #8b5cf6); border: none;">
                        <i class="fas fa-magic me-2"></i>Compare Last Month vs Previous Month
                    </button>
                </div>
            </div>
        </div>
    </div>
</div> <!-- End of Comparison Tab -->

<!-- INVESTMENT TAB -->
{% if config.INVESTMENT_TRACKING_ENABLED %}
<div class="tab-pane fade" id="investment" role="tabpanel" aria-labelledby="investment-tab">
    {% include 'partials/investment_tab.html' %}
</div> <!-- End of Investment Tab -->
{% endif %}
</div> <!-- End of Tab Content -->

</div> <!-- End of Main Container -->
</div> <!-- End of dashboard-container -->
{% endblock content %}

{% block styles %}
<style>
    /* Tab Navigation Styles */
    .nav-tabs .nav-link {
        color: #94a3b8;
        background-color: transparent;
        border-color: transparent;
        border-radius: 0;
        padding: 0.75rem 1.25rem;
        font-weight: 500;
        transition: all 0.3s;
    }
    
    .nav-tabs .nav-link:hover {
        color: #f8fafc;
        border-color: transparent;
        background-color: rgba(148, 163, 184, 0.1);
    }
    
    .nav-tabs .nav-link.active {
        color: inherit;
        background-color: transparent;
        border-color: transparent;
        border-bottom: 3px solid;
    }
    
    /* Card Hover Effects */
    .card {
        transition: transform 0.3s, box-shadow 0.3s;
    }
    
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
    }
    
    /* Financial Health Gauge Styling */
    .metric-card {
        padding: 1rem;
        border-radius: 0.5rem;
        background-color: rgba(15, 23, 42, 0.3);
        border: 1px solid rgba(148, 163, 184, 0.2);
    }
    
    .gauge-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 0.5rem;
    }
    
    .gauge-info {
        margin-top: 0.5rem;
        text-align: center;
        font-size: 0.75rem;
    }
    
    /* Transaction Table Hover Effects */
    .table tbody tr {
        transition: background-color 0.2s;
    }
    
    .table tbody tr:hover {
        background-color: rgba(148, 163, 184, 0.1);
    }
    
    /* Button Hover Effects */
    .btn {
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 10px -1px rgba(0, 0, 0, 0.3);
    }
    
    /* Form Control Styling */
    .form-control, .form-select {
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }
    
    /* Custom Badge Styles */
    .badge {
        padding: 0.35em 0.65em;
        font-weight: 600;
        border-radius: 0.375rem;
    }
    /* Investment Tab Specific Styles */
    .chart-loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10;
        border-radius: 0.375rem;
    }

    /* Investment period button styles */
    .investment-period-btn {
        font-size: 0.85rem;
        padding: 0.25rem 0.5rem;
        transition: all 0.2s ease;
    }

    .investment-period-btn.btn-primary {
        background: linear-gradient(135deg, #10b981, #34d399);
        border: none;
        box-shadow: 0 2px 5px rgba(16, 185, 129, 0.3);
    }

    /* Card styling for investment tab */
    #investment .card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border-radius: 12px;
        overflow: hidden;
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.8));
    }

    #investment .card-header {
        background: rgba(15, 23, 42, 0.7);
        border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        padding: 1rem;
    }

    #investment .card-body {
        padding: 1.25rem;
    }

    #investment .card-footer {
        background: rgba(15, 23, 42, 0.7);
        border-top: 1px solid rgba(148, 163, 184, 0.2);
        padding: 1rem;
    }

    /* Investment metrics */
    #investment .metric-card {
        padding: 1rem;
        border-radius: 0.5rem;
        background-color: rgba(15, 23, 42, 0.3);
        border: 1px solid rgba(148, 163, 184, 0.2);
        transition: transform 0.3s ease;
    }

    #investment .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
    }

    .gauge-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 0.5rem;
    }

    .gauge-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: white;
    }

    .gauge-info {
        margin-top: 0.5rem;
        text-align: center;
        font-size: 0.75rem;
    }

    /* Table styles */
    #investment .table {
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: 0;
    }

    #investment .table thead th {
        color: rgba(255, 255, 255, 0.6);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    #investment .table tbody tr {
        transition: background-color 0.2s;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    #investment .table tbody tr:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }

    #investment .table td, 
    #investment .table th {
        padding: 0.75rem 1rem;
        vertical-align: middle;
    }

    /* Legend styles */
    .legend-container {
        max-height: 200px;
        overflow-y: auto;
        margin-top: 1rem;
        padding-right: 0.5rem;
    }

    .legend-container::-webkit-scrollbar {
        width: 5px;
    }

    .legend-container::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
    }

    .legend-container::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
    }

    /* No data message */
    .no-data-message {
        text-align: center;
        padding: 1.5rem;
        background-color: rgba(15, 23, 42, 0.5);
        border-radius: 0.5rem;
        margin: 1rem 0;
    }

    /* Insights card styles */
    #investmentInsightsCard .card-body {
        padding: 1.25rem;
    }

    #investmentInsightsCard .card {
        background-color: rgba(15, 23, 42, 0.5);
        transition: transform 0.2s ease;
    }

    #investmentInsightsCard .card:hover {
        transform: translateY(-2px);
    }

    /* Progress bar styling */
    .progress {
        height: 6px;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
        overflow: hidden;
    }

    .progress-bar {
        transition: width 0.6s ease;
    }

    /* Toast styling */
    .toast-container {
        z-index: 1070;
    }

    .toast {
        background-color: rgba(15, 23, 42, 0.9);
        backdrop-filter: blur(5px);
    }

    /* Refresh button */
    #refreshInvestmentsBtn {
        transition: background-color 0.2s, transform 0.2s;
    }

    #refreshInvestmentsBtn:hover {
        background-color: rgba(16, 185, 129, 0.3) !important;
        transform: translateY(-2px);
    }

    #refreshInvestmentsBtn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    /* Responsive adjustments */
    @media (max-width: 767.98px) {
        #investment .row > div {
            margin-bottom: 1rem;
        }
        
        #investment .card-header {
            padding: 0.75rem;
        }
        
        #investment .card-body {
            padding: 1rem;
        }
        
        .gauge-value {
            font-size: 1.25rem;
        }
        
        .chart-container {
            height: 250px !important;
        }
}
</style>
    
{% endblock %}

{% block scripts %}
<script>
    window.userAccounts = [
        {% for account in user_accounts %}
        {
            "id": {{ account.id }},
            "name": "{{ account.name }}"
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/stats.js') }}"></script>
<script src="{{ url_for('static', filename='js/investment-charts.js') }}"></script>
<script>

document.addEventListener('DOMContentLoaded', function() {
    // When the investment tab is clicked, initialize its charts
    document.getElementById('investment-tab').addEventListener('click', function() {
        initializeInvestmentCharts();
    });
    
    // Function to initialize investment charts
    function initializeInvestmentCharts() {
        // Portfolio Performance Chart
        const portfolioCtx = document.getElementById('portfolioPerformanceChart')?.getContext('2d');
        if (portfolioCtx) {
            const portfolioPerformanceChart = new Chart(portfolioCtx, {
                type: 'bar',
                data: {
                    labels: [{% for portfolio in portfolio_data|default([]) %}'{{ portfolio.name }}',{% endfor %}],
                    datasets: [{
                        label: 'Current Value',
                        data: [{% for portfolio in portfolio_data|default([]) %}{{ portfolio.value }},{% endfor %}],
                        backgroundColor: '#10b981',
                        borderColor: '#10b981',
                        borderWidth: 1
                    }, {
                        label: 'Cost Basis',
                        data: [{% for portfolio in portfolio_data|default([]) %}{{ portfolio.value - portfolio.gain_loss }},{% endfor %}],
                        backgroundColor: '#8b5cf6',
                        borderColor: '#8b5cf6',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#9ca3af'
                            },
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#9ca3af'
                            },
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e5e7eb'
                            }
                        }
                    }
                }
            });
        }
        
        // Asset Allocation Chart
        const assetCtx = document.getElementById('assetAllocationChart')?.getContext('2d');
        if (assetCtx) {
            const assetAllocationChart = new Chart(assetCtx, {
                type: 'doughnut',
                data: {
                    labels: [{% for portfolio in portfolio_data|default([]) %}'{{ portfolio.name }}',{% endfor %}],
                    datasets: [{
                        data: [{% for portfolio in portfolio_data|default([]) %}{{ portfolio.value }},{% endfor %}],
                        backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ec4899', '#8b5cf6', '#6b7280']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#e5e7eb'
                            }
                        }
                    }
                }
            });
        }
        
        // Sector Distribution Chart
        const sectorCtx = document.getElementById('sectorDistributionChart')?.getContext('2d');
        if (sectorCtx) {
            const sectorDistributionChart = new Chart(sectorCtx, {
                type: 'pie',
                data: {
                    labels: [{% for sector in sector_labels|default([]) %}'{{ sector }}',{% endfor %}],
                    datasets: [{
                        data: [{% for value in sector_values|default([]) %}{{ value }},{% endfor %}],
                        backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ec4899', '#8b5cf6', '#6b7280', '#ef4444']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#e5e7eb'
                            }
                        }
                    }
                }
            });
        }
    }
    
    // Handle refresh investments button
    const refreshBtn = document.getElementById('refreshInvestmentsBtn');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Updating...';
            this.disabled = true;
            
            fetch('/update_prices', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    const toastContainer = document.querySelector('.toast-container');
                    const toastHtml = `
                        <div class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3000">
                            <div class="toast-header bg-success text-white">
                                <i class="fas fa-check-circle me-2"></i>
                                <strong class="me-auto">Success</strong>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                            </div>
                            <div class="toast-body">
                                ${data.message}
                            </div>
                        </div>
                    `;
                    
                    if (toastContainer) {
                        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
                        const toast = new bootstrap.Toast(toastContainer.querySelector('.toast:last-child'));
                        toast.show();
                    }
                    
                    // Reload the page after a short delay
                    setTimeout(() => location.reload(), 1500);
                } else {
                    this.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Refresh Prices';
                    this.disabled = false;
                    alert(data.message || 'Error updating prices');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                this.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Refresh Prices';
                this.disabled = false;
                alert('An error occurred while updating prices');
            });
        });
    }
});

</script>

{% endblock %}